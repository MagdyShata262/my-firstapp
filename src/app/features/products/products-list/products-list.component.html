<div class="container mx-auto px-4 py-8">
  <!-- العنوان وشريط التحكم -->
  <div
    class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4"
  >
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Products</h1>
      <p class="text-gray-600 mt-2">Manage your product inventory</p>
    </div>

    <div class="flex flex-wrap gap-3">
      <!-- زر إضافة منتج جديد -->
      <button
        (click)="openAddProductModal()"
        class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex items-center gap-2"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"
          ></path>
        </svg>
        Add Product
      </button>

      <!-- زر تحديث -->
      <button
        (click)="refreshProducts()"
        [disabled]="productsStore.loading()"
        class="bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex items-center gap-2"
      >
        <svg
          class="w-5 h-5"
          [class.animate-spin]="productsStore.loading()"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
          ></path>
        </svg>
        Refresh
      </button>

      <!-- زر مسح الفلاتر -->
      <button
        (click)="clearAllFilters()"
        class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex items-center gap-2"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
          ></path>
        </svg>
        Clear Filters
      </button>
    </div>
  </div>

  <!-- حالة التحميل -->
  <div
    *ngIf="productsStore.loading() && productsStore.products().length === 0"
    class="text-center py-12"
  >
    <div
      class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto"
    ></div>
    <p class="text-gray-600 mt-4 text-lg">Loading products...</p>
  </div>

  <!-- رسالة الخطأ -->
  <div
    *ngIf="productsStore.error() && !productsStore.loading()"
    class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6"
  >
    <div class="flex items-start gap-4">
      <div class="flex-1">
        <h3 class="text-red-800 font-semibold text-lg mb-2">
          Error Loading Products
        </h3>
        <p class="text-red-600">{{ productsStore.error() }}</p>
      </div>
      <button
        (click)="productsStore.clearError()"
        class="text-red-600 hover:text-red-800 transition-colors"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- شريط الفلاتر والبحث -->
  <div
    *ngIf="!productsStore.loading() || productsStore.products().length > 0"
    class="bg-white rounded-lg shadow-sm border p-6 mb-6"
  >
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- البحث -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Search Products</label
        >
        <div class="relative">
          <input
            type="text"
            placeholder="Search by title, description, or category..."
            [value]="productsStore.searchQuery()"
            (input)="onSearch($event)"
            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
          />
          <svg
            class="absolute left-3 top-3.5 w-4 h-4 text-gray-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            ></path>
          </svg>
        </div>
      </div>

      <!-- التصنيف -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Category</label
        >
        <select
          [value]="productsStore.selectedCategory() || ''"
          (change)="onCategoryChange($event)"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
        >
          <option value="">All Categories</option>
          <option
            *ngFor="let category of productsStore.categories()"
            [value]="category"
          >
            {{ category }}
          </option>
        </select>
      </div>

      <!-- الترتيب -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Sort By</label
        >
        <select
          [value]="productsStore.sortBy() || ''"
          (change)="onSortChange($event)"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
        >
          <option value="">Default</option>
          <option value="title">Title A-Z</option>
          <option value="price">Price Low-High</option>
          <option value="price-desc">Price High-Low</option>
          <option value="category">Category</option>
        </select>
      </div>
    </div>

    <!-- إحصائيات سريعة -->
    <div
      *ngIf="productsStore.productStats()"
      class="mt-6 pt-6 border-t border-gray-200"
    >
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="text-center">
          <div class="text-2xl font-bold text-blue-600">
            {{ productsStore.productStats().total }}
          </div>
          <div class="text-sm text-gray-600">Total Products</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-green-600">
            {{ productsStore.productStats().categoriesCount }}
          </div>
          <div class="text-sm text-gray-600">Categories</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-yellow-600">
            {{ productsStore.productStats().averagePrice | currency : "USD" }}
          </div>
          <div class="text-sm text-gray-600">Avg Price</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-red-600">
            {{ productsStore.productStats().highestPrice | currency : "USD" }}
          </div>
          <div class="text-sm text-gray-600">Highest Price</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-purple-600">
            {{ productsStore.productStats().lowestPrice | currency : "USD" }}
          </div>
          <div class="text-sm text-gray-600">Lowest Price</div>
        </div>
      </div>
    </div>
  </div>

  <!-- نتائج البحث -->
  <div
    *ngIf="productsStore.searchQuery() || productsStore.selectedCategory()"
    class="mb-4 flex items-center gap-2 text-sm text-gray-600"
  >
    <span>Filtered results:</span>
    <span class="font-semibold"
      >{{ productsStore.sortedProducts().length }} products</span
    >
    <button
      (click)="clearAllFilters()"
      class="text-blue-600 hover:text-blue-800 underline"
    >
      Clear all
    </button>
  </div>

  <!-- قائمة المنتجات -->
  <div
    *ngIf="!productsStore.loading() || productsStore.products().length > 0"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8"
  >
    <div
      *ngFor="let product of productsStore.paginatedProducts()"
      class="bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-300 overflow-hidden group"
    >
      <!-- صورة المنتج -->
      <div class="relative overflow-hidden">
        <img
          [src]="product.image"
          [alt]="product.title"
          class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"
        />

        <!-- شريط التصنيف -->
        <div class="absolute top-3 left-3">
          <span
            class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-semibold"
          >
            {{ product.category }}
          </span>
        </div>

        <!-- سعر المنتج -->
        <div class="absolute top-3 right-3">
          <span
            class="bg-green-600 text-white px-3 py-1 rounded-lg text-sm font-bold"
          >
            {{ product.price | currency : "USD" }}
          </span>
        </div>

        <!-- زر الإجراءات السريعة -->
        <div
          class="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
        >
          <div class="flex gap-2">
            <!-- استخدام RouterLink بدلاً من زر View Details -->
            <a
              [routerLink]="['/products', product.id]"
              [queryParams]="{ view: 'details' }"
              class="bg-white text-blue-600 p-2 rounded-lg shadow-md hover:bg-blue-50 transition-colors"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                ></path>
              </svg>
            </a>
            <button
              (click)="editProduct(product)"
              class="bg-white text-yellow-600 p-2 rounded-lg shadow-md hover:bg-yellow-50 transition-colors"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                ></path>
              </svg>
            </button>
            <button
              (click)="deleteProduct(product.id)"
              class="bg-white text-red-600 p-2 rounded-lg shadow-md hover:bg-red-50 transition-colors"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- محتوى البطاقة -->
      <div class="p-4">
        <h3
          class="font-bold text-lg text-gray-900 mb-2 line-clamp-2 leading-tight"
        >
          {{ product.title }}
        </h3>

        <p class="text-gray-600 text-sm mb-4 line-clamp-2">
          {{ product.description }}
        </p>

        <!-- التقييم -->
        <div *ngIf="product.rating" class="flex items-center gap-2 mb-4">
          <div class="flex items-center">
            <span
              *ngFor="let star of getStars(product.rating.rate)"
              [class]="getStarClass(star.type)"
              class="text-lg"
            >
              {{ getStarIcon(star.type) }}
            </span>
          </div>
          <span class="text-sm text-gray-600">
            {{ product.rating.rate }} ({{ product.rating.count }} reviews)
          </span>
        </div>

        <!-- أزرار الإجراءات -->
        <div class="flex gap-2">
          <!-- استخدام RouterLink للتنقل إلى صفحة تفاصيل المنتج -->
          <a
            [routerLink]="['/products', product.id]"
            [queryParams]="{ view: 'details' }"
            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-semibold transition-colors text-sm text-center flex items-center justify-center"
          >
            View Details
          </a>
          <button
            (click)="addToCart(product)"
            class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-semibold transition-colors text-sm"
          >
            Add to Cart
          </button>
        </div>

        <!-- زر المفضلة -->
        <div class="mt-3 flex justify-center">
          <button
            (click)="toggleFavorite(product.id)"
            [class.text-red-500]="isFavorite(product.id)"
            [class.text-gray-400]="!isFavorite(product.id)"
            class="p-2 rounded-full hover:bg-gray-100 transition-colors"
          >
            <svg
              class="w-5 h-5"
              [class.fill-current]="isFavorite(product.id)"
              [class.stroke-current]="!isFavorite(product.id)"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- لا توجد منتجات -->
  <div
    *ngIf="
      productsStore.paginatedProducts().length === 0 && !productsStore.loading()
    "
    class="text-center py-12"
  >
    <svg
      class="w-24 h-24 text-gray-300 mx-auto mb-4"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="1"
        d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0H4m16 0h-4m-4 0H8"
      ></path>
    </svg>
    <h3 class="text-xl font-semibold text-gray-600 mb-2">No products found</h3>
    <p class="text-gray-500 mb-6">
      Try adjusting your search or filter criteria
    </p>
    <button
      (click)="clearAllFilters()"
      class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"
    >
      Clear Filters
    </button>
  </div>

  <!-- الترقيم -->
  <div
    *ngIf="
      productsStore.totalPages() > 1 &&
      productsStore.paginatedProducts().length > 0
    "
    class="flex flex-col sm:flex-row justify-between items-center gap-4 py-6 border-t border-gray-200"
  >
    <div class="text-sm text-gray-600">
      Showing {{ displayRange().start }}-{{ displayRange().end }} of
      {{ productsStore.sortedProducts().length }} products
    </div>

    <div class="flex items-center gap-2">
      <button
        (click)="previousPage()"
        [disabled]="!productsStore.hasPreviousPage()"
        class="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"
          ></path>
        </svg>
        Previous
      </button>

      <div class="flex gap-1">
        <button
          *ngFor="let page of visiblePages()"
          (click)="goToPage(page)"
          [class.bg-blue-600]="page === productsStore.currentPage()"
          [class.text-white]="page === productsStore.currentPage()"
          [class.text-gray-700]="page !== productsStore.currentPage()"
          class="w-10 h-10 rounded-lg border transition-colors hover:bg-blue-50"
        >
          {{ page }}
        </button>
      </div>

      <button
        (click)="nextPage()"
        [disabled]="!productsStore.hasNextPage()"
        class="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        Next
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5l7 7-7 7"
          ></path>
        </svg>
      </button>
    </div>

    <div class="flex items-center gap-2 text-sm">
      <span class="text-gray-600">Items per page:</span>
      <select
        [value]="productsStore.pageSize()"
        (change)="onPageSizeChange($event)"
        class="border border-gray-300 rounded-lg px-3 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
      >
        <option value="12">12</option>
        <option value="24">24</option>
        <option value="48">48</option>
      </select>
    </div>
  </div>

  <!-- نافذة إضافة منتج -->
  <div
    *ngIf="showAddProductModal()"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
  >
    <div
      class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
    >
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-2xl font-bold text-gray-900">Add New Product</h2>
      </div>

      <div class="p-6">
        <form (ngSubmit)="onAddProductSubmit()" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Title *</label
              >
              <input
                type="text"
                [(ngModel)]="newProduct.title"
                name="title"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Price *</label
              >
              <input
                type="number"
                [(ngModel)]="newProduct.price"
                name="price"
                step="0.01"
                min="0"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Category *</label
              >
              <input
                type="text"
                [(ngModel)]="newProduct.category"
                name="category"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Image URL *</label
              >
              <input
                type="url"
                [(ngModel)]="newProduct.image"
                name="image"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              />
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Description *</label
              >
              <textarea
                [(ngModel)]="newProduct.description"
                name="description"
                rows="4"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              ></textarea>
            </div>
          </div>

          <div class="flex justify-end gap-3 pt-6">
            <button
              type="button"
              (click)="closeAddProductModal()"
              class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold"
            >
              Cancel
            </button>
            <button
              type="submit"
              [disabled]="!isValidProduct()"
              class="bg-green-600 hover:bg-green-700 disabled:bg-green-300 text-white px-6 py-3 rounded-lg font-semibold transition-colors"
            >
              Add Product
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
